<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Determination and Management System</title>
<style>
    /* General Styling */
body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    margin: 0;
    padding: 20px;
    color: #333;
}

.container, .calculator-container {
    max-width: 1200px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    padding: 25px;
}

.form-group, .form-row {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
}

input, select {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #f9f9fb;
    transition: border-color 0.3s;
}

input:focus, select:focus {
    border-color: #007BFF;
    outline: none;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    background-color: #007BFF;
    color: #ffffff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
}

.btn:hover {
    background-color: #0056b3;
}

.order-table, table {
    width: 100%;
    margin-top: 25px;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 10px;
    overflow: hidden;
}

.order-table th, .order-table td, th, td {
    border-bottom: 1px solid #e0e0e0;
    padding: 12px 15px;
    text-align: center;
    color: #333;
}

.order-table th {
    background-color: #f1f5f9;
    font-weight: 600;
    color: #444;
}

.toggle-btn {
    display: block;
    margin: 15px auto;
    background-color: #10b981;
    padding: 10px 24px;
    font-weight: 600;
}

.toggle-btn:hover {
    background-color: #059669;
}

.hidden {
    display: none;
}

.tab {
    display: inline-block;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    font-weight: 500;
    color: #555;
    transition: color 0.3s, border-color 0.3s;
}

.tab.active {
    border-bottom: 2px solid #007BFF;
    color: #007BFF;
}

.tab-content {
    display: none;
    margin-top: 20px;
}

.tab-content.active {
    display: block;
}
</style>
</head>
<body>

<div class="calculator-container">
    <h2>Supplier Determination Calculator</h2>
    <div class="form-group">
        <label for="serviceType">Select Service Type:</label>
        <select id="serviceType">
            <option value="">Select a service</option>
            <option value="bankTransferSaver">Bank Transfer (Saver)</option>
            <option value="bankTransferExpress">Bank Transfer (Express)</option>
            <option value="bankTransferUSD">Bank Transfer (USD)</option>
            <option value="enterpriseToEnterprise">Enterprise to Enterprise</option>
            <option value="alipay">Alipay</option>
        </select>
    </div>
    <div class="form-group">
        <label for="orderAmount">Enter Order Amount (must be > 0.01):</label>
        <input type="number" id="orderAmount" min="0.01" step="0.01" placeholder="Enter amount">
    </div>
    <div id="additionalQuestions"></div>
    <button class="btn" id="createOrderBtn">Create Order</button>
    <button class="btn" id="calculateBestSupplierBtn">Calculate the Best Supplier</button>

    <table class="order-table" id="orderTable">
        <thead>
            <tr>
                <th>Service Type</th>
                <th>Order Amount</th>
                <th>Additional Info</th>
                <th>Best Supplier</th>
            </tr>
        </thead>
        <tbody>
            <!-- Orders will be populated here -->
        </tbody>
    </table>
</div>

<button class="btn toggle-btn" id="toggleManagementBtn">Show Supplier Management</button>

<div class="container hidden" id="supplierManagementSection">
    <h2>Supplier Management</h2>

    <h3>Daily Rate</h3>
    <div id="daily-rate-section"></div>
    <!-- Buttons for Daily Rate Section -->
    <div id="daily-rate-actions">
    <button class="btn" id="save-rates-btn">Save Rates</button>
    <button class="btn" id="clear-rates-btn">Clear Rates</button>
    </div>
    <h3>Add/Edit Supplier</h3>
    <div class="form-row">
        <label for="supplier-name">Supplier Name</label>
        <input type="text" id="supplier-name" placeholder="Enter supplier name">
    </div>
    <div class="form-row">
        <label for="service-type">Service Type</label>
        <select id="service-type">
            <option value="bank-express">Bank Transfer (Express)</option>
            <option value="bank-saver">Bank Transfer (Saver)</option>
            <option value="enterprise">Enterprise to Enterprise</option>
            <option value="usd-transfer">Bank Transfer (USD)</option>
            <option value="alipay">Alipay Transfer</option>
        </select>
    </div>
    <div class="form-row">
        <label>Amount Limits</label>
        <div id="amount-limits-section"></div>
    </div>
    <button class="btn" id="add-amount-range-btn">Add Amount Range</button>

    <div class="form-row">
        <label>Service Charges</label>
        <div id="service-charge-section"></div>
    </div>
    <button class="btn" id="add-service-charge-btn">Add Service Charge</button>

    <h3>Additional Questions</h3>
    <div id="additional-questions-container"></div>

    <button class="btn" id="add-supplier-btn">Add Supplier</button>
    <button id="save-edit-btn" class="btn hidden">Save Edit</button>
    <button id="cancel-edit-btn" class="btn hidden">Cancel Edit</button>

    <h3>Supplier Information</h3>
    <button id="sync-suppliers-btn" class="btn">Sync Suppliers to Google Sheet</button>
    <button id="fetch-suppliers-btn" class="btn">Fetch Suppliers from Google Sheets</button>
    <div class="tabs" id="service-tabs">
        <div class="tab" data-service="bank-express">Bank Transfer (Express)</div>
        <div class="tab" data-service="bank-saver">Bank Transfer (Saver)</div>
        <div class="tab" data-service="enterprise">Enterprise to Enterprise</div>
        <div class="tab" data-service="usd-transfer">Bank Transfer (USD)</div>
        <div class="tab" data-service="alipay">Alipay Transfer</div>
    </div>

    <div id="tab-content-container">
        <div class="tab-content" id="bank-express-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bank-express-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="bank-saver-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bank-saver-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="enterprise-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="enterprise-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="usd-transfer-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usd-transfer-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="alipay-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alipay-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let suppliers = [];
let editingSupplierIndex = -1;

// Load suppliers from localStorage on page load
window.addEventListener('load', function () {
    const storedSuppliers = localStorage.getItem('suppliers');
    if (storedSuppliers) {
        suppliers = JSON.parse(storedSuppliers);
        updateSupplierTables();
        updateDailyRateSection();
    }
});

// Toggle Supplier Management Section
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('toggleManagementBtn').addEventListener('click', function () {
        const section = document.getElementById('supplierManagementSection');
        section.classList.toggle('hidden');
        this.textContent = section.classList.contains('hidden') ? 'Show Supplier Management' : 'Hide Supplier Management';
    });
});

// Add Amount Range
document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('add-amount-range-btn').addEventListener('click', () => {
    const amountRangeItem = document.createElement('div');
    amountRangeItem.classList.add('amount-range-item');
    amountRangeItem.innerHTML = `
        <input type="text" class="amount-range" placeholder="e.g. '> 0.01' or '10000 - 20000'" />
        <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
    `;
    document.getElementById('amount-limits-section').appendChild(amountRangeItem);
  });
});

// Add Service Charge
document.addEventListener('DOMContentLoaded', function () {
document.getElementById('add-service-charge-btn').addEventListener('click', () => {
    const serviceChargeItem = document.createElement('div');
    serviceChargeItem.classList.add('service-charge-item');
    serviceChargeItem.innerHTML = `
        <div>
            <label>Condition</label>
            <input type="text" class="service-condition" placeholder="e.g. '> 50,000 CNY'" />
        </div>
        <div>
            <label>Charge</label>
            <input type="text" class="service-charge" placeholder="e.g. '50 CNY'" />
        </div>
        <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        <div class="additional-questions-container"></div>
    `;
    document.getElementById('service-charge-section').appendChild(serviceChargeItem);
});

// Evaluate service charge conditions during calculations
function evaluateCondition(condition, amount) {
    try {
        if (!condition) return false;
        condition = condition.toLowerCase().trim();

        if (condition.includes('>')) {
            const value = parseFloat(condition.split('>')[1].trim());
            return amount > value;
        } else if (condition.includes('<')) {
            const value = parseFloat(condition.split('<')[1].trim());
            return amount < value;
        } else if (condition.includes('-')) {
            const [min, max] = condition.split('-').map(val => parseFloat(val.trim()));
            return amount >= min && amount <= max;
        }

        return false;
    } catch (error) {
        console.error(`Error evaluating condition: ${condition}`, error);
        return false;
    }
}

// Calculate service charges during order processing
function calculateServiceCharge(orderAmount, serviceCharges) {
    let totalServiceCharge = 0;

    serviceCharges.forEach(charge => {
        const condition = charge.condition;
        const chargeAmount = parseFloat(charge.charge.replace(/[^0-9.]/g, '')); // Extract numeric value of charge
        if (evaluateCondition(condition, orderAmount)) {
            totalServiceCharge += chargeAmount;
        }
    });

    return totalServiceCharge;
}

// Example Usage:
const serviceCharges = [
    { condition: '> 50,000 CNY', charge: '50 CNY' },
    { condition: '< 10,000 CNY', charge: '20 CNY' }
];
const orderAmount = 60000;

console.log('Service Charge:', calculateServiceCharge(orderAmount, serviceCharges)); // Output: 50


    // Add dynamic additional questions logic
    const conditionInput = serviceChargeItem.querySelector('.service-condition');
    conditionInput.addEventListener('input', function () {
        handleAdditionalQuestions(this);
    });
});

// Handle Additional Questions Based on Service Type
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM fully loaded and parsed'); // Debugging: Ensure script runs

    // Handle Additional Questions Based on Service Type
    function handleAdditionalQuestionsForSupplier(serviceType) {
        const questionsContainer = document.getElementById('additional-questions-container');
        
        // Clear any existing questions
        questionsContainer.innerHTML = '';

        // Define additional questions for each service type
        const additionalQuestionsMap = {
            'bank-express': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: '工商银行 Account', type: 'select', options: ['Yes', 'No'] },
                { label: '农业银行 Account', type: 'select', options: ['Yes', 'No'] }
            ],
            'bank-saver': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: '工商银行 Account', type: 'select', options: ['Yes', 'No'] },
                { label: '农业银行 Account', type: 'select', options: ['Yes', 'No'] }
            ],
            'usd-transfer': [
                { label: 'Account Type', type: 'select', options: ['Personal', 'Company'] }
            ],
            'alipay': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: 'Chinese Account', type: 'select', options: ['Yes', 'No'] }
            ]
        };

        // Get the questions for the selected service type
        const questions = additionalQuestionsMap[serviceType];

        // Render the questions if they exist
        if (questions) {
            questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('form-group');
                questionDiv.innerHTML = `
                    <label>${question.label}</label>
                    ${
                        question.type === 'select'
                            ? `<select>${question.options.map(option => `<option value="${option.toLowerCase()}">${option}</option>`).join('')}</select>`
                            : `<input type="${question.type}" placeholder="${question.placeholder || ''}" />`
                    }
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }
    }

    // Add event listener for service type selection
    const serviceTypeDropdown = document.getElementById('service-type');
    if (serviceTypeDropdown) {
        serviceTypeDropdown.addEventListener('change', function () {
            const selectedServiceType = this.value;
            console.log('Service Type Selected:', selectedServiceType); // Debugging: Log selected service type
            handleAdditionalQuestionsForSupplier(selectedServiceType);
        });
    }
});

// Add Supplier Functionality
document.addEventListener('DOMContentLoaded', function () {
    const addSupplierButton = document.getElementById('add-supplier-btn');
    const cancelEditButton = document.getElementById('cancel-edit-btn'); // Add this to toggle edit mode
    let suppliers = [];
    let editingSupplierIndex = -1;

    // Load suppliers from localStorage on page load
    const storedSuppliers = localStorage.getItem('suppliers');
    if (storedSuppliers) {
        suppliers = JSON.parse(storedSuppliers);
        updateSupplierTables(); // Ensure tables are populated
    }

    if (addSupplierButton) {
        addSupplierButton.addEventListener('click', () => {
            console.log('Add Supplier Button Clicked'); // Log button click

            // Get supplier details
            const name = document.getElementById('supplier-name')?.value.trim();
            const serviceType = document.getElementById('service-type')?.value;
            const amountLimits = Array.from(document.querySelectorAll('.amount-range'))
                .map(input => input.value.trim())
                .filter(limit => limit); // Remove empty values
            const serviceCharges = Array.from(document.querySelectorAll('.service-charge-item'))
                .map(item => {
                    const condition = item.querySelector('.service-condition')?.value.trim();
                    const charge = item.querySelector('.service-charge')?.value.trim();
                    return { condition, charge };
                })
                .filter(charge => charge.condition && charge.charge); // Remove incomplete entries
            const additionalQuestions = Array.from(document.querySelectorAll('.additional-question-item'))
                .map(item => {
                    const label = item.querySelector('.question-label')?.textContent.trim();
                    const value = item.querySelector('.question-answer')?.value.trim();
                    return { label, value };
                });
            const isActive = document.getElementById('supplier-status')?.checked;

            // Validation with detailed error messages
            if (!name) {
                alert('Supplier name is required');
                console.error('Validation Error: Supplier name is missing');
                return;
            }
            if (!serviceType) {
                alert('Service type is required');
                console.error('Validation Error: Service type is missing');
                return;
            }
            if (amountLimits.length === 0) {
                alert('At least one amount limit is required');
                console.error('Validation Error: Amount limits are missing');
                return;
            }

            // Prepare supplier data
            const supplierData = {
                name,
                isActive,
                services: [{
                    serviceType,
                    amountLimits: amountLimits.map(limit => ({ limit, rate: null })),
                    serviceCharges,
                    additionalQuestions
                }]
            };

            console.log('Supplier Data Prepared:', supplierData); // Log supplier data

            if (editingSupplierIndex === -1) {
                // Add new supplier
                suppliers.push(supplierData);
                showNotification(`Supplier "${name}" added successfully!`, 'success');
            } else {
                // Update existing supplier
                suppliers[editingSupplierIndex] = supplierData;
                editingSupplierIndex = -1;
                addSupplierButton.textContent = 'Add Supplier'; // Reset button label
                showNotification(`Supplier "${name}" updated successfully!`, 'success');
                toggleEditMode(false); // Exit edit mode
            }

            // Save to localStorage
            localStorage.setItem('suppliers', JSON.stringify(suppliers));

            // Update UI
            updateSupplierTables();
            updateDailyRateSection();
            clearSupplierForm(); // Clear the form for new entries
        });
    } else {
        console.error('Add Supplier Button not found'); // Log missing button
    }

    if (cancelEditButton) {
        cancelEditButton.addEventListener('click', () => {
            editingSupplierIndex = -1;
            toggleEditMode(false); // Exit edit mode
        });
    }

    // Toggle edit mode
    function toggleEditMode(isEditMode) {
    const addSupplierButton = document.getElementById('add-supplier-btn');
    const saveEditButton = document.getElementById('save-edit-btn');
    const cancelEditButton = document.getElementById('cancel-edit-btn');

    if (isEditMode) {
        saveEditButton.classList.remove('hidden');
        cancelEditButton.classList.remove('hidden');
        addSupplierButton.classList.add('hidden');
    } else {
        saveEditButton.classList.add('hidden');
        cancelEditButton.classList.add('hidden');
        addSupplierButton.classList.remove('hidden');
    }
}

    // Clear Supplier Form
    function clearSupplierForm() {
        document.getElementById('supplier-name').value = '';
        document.getElementById('service-type').value = '';
        document.getElementById('supplier-status').checked = false;
        document.getElementById('amount-limits-section').innerHTML = '';
        document.getElementById('service-charge-section').innerHTML = '';
        document.getElementById('additional-questions-container').innerHTML = '';
    }

    // Notification Function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.className = `notification ${type}`;

        // Notification styling
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.right = '20px';
        notification.style.backgroundColor = type === 'success' ? '#10b981' : '#f59e0b';
        notification.style.color = 'white';
        notification.style.padding = '15px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0px 4px 15px rgba(0, 0, 0, 0.2)';
        notification.style.fontSize = '16px';
        notification.style.zIndex = 1000; // Ensure it's above other elements

        document.body.appendChild(notification);

        // Auto-remove notification after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Update Supplier Tables (Placeholder: Ensure this is implemented)
    function updateSupplierTables() {
        console.log('Updating supplier tables...');
        // Your implementation here
    }

    // Update Daily Rate Section (Placeholder: Ensure this is implemented)
    function updateDailyRateSection() {
        console.log('Updating daily rate section...');
        // Your implementation here
    }
});


    // Update Supplier Tables
function updateSupplierTables() {
    const tables = {
        'bank-express': document.getElementById('bank-express-table-body'),
        'bank-saver': document.getElementById('bank-saver-table-body'),
        'enterprise': document.getElementById('enterprise-table-body'),
        'usd-transfer': document.getElementById('usd-transfer-table-body'),
        'alipay': document.getElementById('alipay-table-body')
    };

    // Clear existing rows
    Object.values(tables).forEach(table => {
        if (table) table.innerHTML = '';
    });

    suppliers.forEach((supplier, supplierIndex) => {
        if (!supplier.services || supplier.services.length === 0) return;

        supplier.services.forEach(service => {
            const table = tables[service.serviceType];
            if (!table) {
                console.error(`Invalid service type: ${service.serviceType}`);
                return;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${supplier.name}</td>
                <td>${service.amountLimits.map(a => a.limit).join(', ')}</td>
                <td>${service.serviceCharges.map(c => `${c.condition}: ${c.charge}`).join(', ')}</td>
                <td>
                    <button class="edit-btn">Edit</button>
                    <button class="delete-btn">Delete</button>
                </td>
            `;

            // Avoid duplicate listeners
            row.querySelector('.edit-btn').onclick = () => editSupplier(supplierIndex);
            row.querySelector('.delete-btn').onclick = () => deleteSupplier(supplierIndex);

            table.appendChild(row);
        });
    });
}

    console.log('Supplier tables updated.'); // Debugging
}

    // Add or Update Supplier
   document.getElementById('add-supplier-btn').addEventListener('click', function () {
    const name = document.getElementById('supplier-name').value.trim();
    const serviceType = document.getElementById('service-type').value;
    const isActive = document.getElementById('supplier-status')?.checked;
    const amountLimits = Array.from(document.querySelectorAll('.amount-range'))
        .map(input => input.value.trim())
        .filter(limit => limit); // Filter out empty inputs
    const serviceCharges = Array.from(document.querySelectorAll('.service-charge-item')).map(item => {
        return {
            condition: item.querySelector('.service-condition').value.trim(),
            charge: item.querySelector('.service-charge').value.trim()
        };
    });
    const additionalQuestions = Array.from(document.querySelectorAll('.additional-question-item')).map(item => {
        return {
            label: item.querySelector('.question-label').textContent.trim(),
            value: item.querySelector('.question-answer').value.trim()
        };
    });

    // Validation
    if (!name || !serviceType || amountLimits.length === 0) {
        alert('Please fill out all required fields.');
        return;
    }

    // Create supplier data object
    const supplierData = {
        name,
        isActive,
        services: [{
            serviceType,
            amountLimits: amountLimits.map(limit => ({ limit, rate: null })), // Initialize rate as null
            serviceCharges,
            additionalQuestions // Include additional questions
        }]
    };

    // Add new supplier or update existing one
    if (editingSupplierIndex === -1) {
        suppliers.push(supplierData);
        showNotification(`Supplier "${name}" added successfully!`, 'success');
    } else {
        suppliers[editingSupplierIndex] = supplierData;
        editingSupplierIndex = -1;
        this.textContent = 'Add Supplier';
        showNotification(`Supplier "${name}" updated successfully!`, 'success');
    }

    // Save suppliers to localStorage
    localStorage.setItem('suppliers', JSON.stringify(suppliers));

    // Update supplier tables and clear the form
    updateSupplierTables();
    updateDailyRateSection(); // Ensure the daily rate section reflects changes
    clearSupplierForm();
});

    // Toggle Supplier Status
    function toggleSupplierStatus(index) {
        suppliers[index].isActive = !suppliers[index].isActive;

        // Save updated suppliers to localStorage
        localStorage.setItem('suppliers', JSON.stringify(suppliers));

        // Update the supplier tables in the UI
        updateSupplierTables();

        // Show a notification
        showNotification(
            `Supplier "${suppliers[index].name}" is now ${suppliers[index].isActive ? 'Active' : 'Inactive'}!`,
            'success'
        );
    }

    // Delete Supplier Function
    function deleteSupplier(index) {
        const confirmDelete = confirm("Are you sure you want to delete this supplier?");
        if (!confirmDelete) return;

        suppliers.splice(index, 1);

        // Save updated suppliers to localStorage
        localStorage.setItem('suppliers', JSON.stringify(suppliers));

        // Update the supplier tables in the UI
        updateSupplierTables();

        // Show success notification
        showNotification('Supplier deleted successfully!', 'success');
    }

    document.addEventListener('DOMContentLoaded', function () {
    // Declare global variables
    let suppliers = [];
    let editingSupplierIndex = -1;

    // Edit Supplier
    function editSupplier(index) {
    const supplier = suppliers[index];
    if (!supplier) {
        console.error(`Supplier at index ${index} not found.`);
        return;
    }

    document.getElementById('supplier-name').value = supplier.name;
    document.getElementById('service-type').value = supplier.services[0].serviceType;
    document.getElementById('supplier-status').checked = supplier.isActive;

    document.getElementById('amount-limits-section').innerHTML = '';
    supplier.services[0].amountLimits.forEach(range => {
        const amountRangeItem = document.createElement('div');
        amountRangeItem.classList.add('amount-range-item');
        amountRangeItem.innerHTML = `
            <input type="text" class="amount-range" value="${range.limit}" />
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        `;
        document.getElementById('amount-limits-section').appendChild(amountRangeItem);
    });

    document.getElementById('service-charge-section').innerHTML = '';
    supplier.services[0].serviceCharges.forEach(charge => {
        const serviceChargeItem = document.createElement('div');
        serviceChargeItem.classList.add('service-charge-item');
        serviceChargeItem.innerHTML = `
            <div>
                <label>Condition</label>
                <input type="text" class="service-condition" value="${charge.condition}" />
            </div>
            <div>
                <label>Charge</label>
                <input type="text" class="service-charge" value="${charge.charge}" />
            </div>
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        `;
        document.getElementById('service-charge-section').appendChild(serviceChargeItem);
    });

    editingSupplierIndex = index;
    toggleEditMode(true);
    showNotification('You have entered edit mode.', 'info');
}

    // Clear Supplier Form
    function clearSupplierForm() {
    const nameInput = document.getElementById('supplier-name');
    const serviceTypeInput = document.getElementById('service-type');
    const amountLimitsSection = document.getElementById('amount-limits-section');
    const serviceChargeSection = document.getElementById('service-charge-section');

    if (nameInput) nameInput.value = '';
    if (serviceTypeInput) serviceTypeInput.value = '';
    if (amountLimitsSection) amountLimitsSection.innerHTML = '';
    if (serviceChargeSection) serviceChargeSection.innerHTML = '';

    editingSupplierIndex = -1;
}

    // Tab-Switching Functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const target = this.dataset.service;

            // Deactivate all tabs and hide content
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            // Activate the clicked tab and show its content
            this.classList.add('active');
            document.getElementById(`${target}-tab`).classList.add('active');
        });
    });

    // Function to show notifications
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.right = '20px';
        notification.style.backgroundColor = type === 'success' ? '#10b981' : '#f59e0b';
        notification.style.color = 'white';
        notification.style.padding = '15px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0px 4px 15px rgba(0, 0, 0, 0.2)';
        notification.style.fontSize = '16px';
        notification.style.zIndex = 1000;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Define updateSupplierTables to avoid reference error
    function updateSupplierTables() {
    const tables = {
        'bank-express': document.getElementById('bank-express-table-body'),
        'bank-saver': document.getElementById('bank-saver-table-body'),
        'enterprise': document.getElementById('enterprise-table-body'),
        'usd-transfer': document.getElementById('usd-transfer-table-body'),
        'alipay': document.getElementById('alipay-table-body')
    };

    Object.values(tables).forEach(table => {
        if (table) table.innerHTML = ''; // Clear existing rows
    });

    suppliers.forEach((supplier, supplierIndex) => {
        supplier.services.forEach(service => {
            const table = tables[service.serviceType];
            if (!table) return;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${supplier.name}</td>
                <td>${service.amountLimits.map(a => a.limit).join(', ')}</td>
                <td>${service.serviceCharges.map(c => `${c.condition}: ${c.charge}`).join(', ')}</td>
                <td>
                    <button class="edit-btn">Edit</button>
                    <button class="delete-btn">Delete</button>
                </td>
            `;

            row.querySelector('.edit-btn').addEventListener('click', () => {
                editSupplier(supplierIndex);
            });

            row.querySelector('.delete-btn').addEventListener('click', () => {
                deleteSupplier(supplierIndex);
            });

            table.appendChild(row);
        });
    });
}

// Edit Supplier
function editSupplier(index) {
    const supplier = suppliers[index];
    if (!supplier) {
        console.error(`Supplier at index ${index} not found.`);
        return;
    }

    document.getElementById('supplier-name').value = supplier.name;
    document.getElementById('service-type').value = supplier.services[0].serviceType;
    document.getElementById('supplier-status').checked = supplier.isActive;

    document.getElementById('amount-limits-section').innerHTML = '';
    supplier.services[0].amountLimits.forEach(range => {
        const amountRangeItem = document.createElement('div');
        amountRangeItem.classList.add('amount-range-item');
        amountRangeItem.innerHTML = `
            <input type="text" class="amount-range" value="${range.limit}" />
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        `;
        document.getElementById('amount-limits-section').appendChild(amountRangeItem);
    });

    document.getElementById('service-charge-section').innerHTML = '';
    supplier.services[0].serviceCharges.forEach(charge => {
        const serviceChargeItem = document.createElement('div');
        serviceChargeItem.classList.add('service-charge-item');
        serviceChargeItem.innerHTML = `
            <div>
                <label>Condition</label>
                <input type="text" class="service-condition" value="${charge.condition}" />
            </div>
            <div>
                <label>Charge</label>
                <input type="text" class="service-charge" value="${charge.charge}" />
            </div>
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
            <div class="additional-questions-container"></div>
        `;

        document.getElementById('service-charge-section').appendChild(serviceChargeItem);
    });

    editingSupplierIndex = index;
    document.getElementById('add-supplier-btn').textContent = 'Update Supplier';
}

// Add or Update Supplier with Confirmation
document.getElementById('add-supplier-btn').addEventListener('click', function () {
    const name = document.getElementById('supplier-name').value.trim();
    const serviceType = document.getElementById('service-type').value;
    const isActive = document.getElementById('supplier-status')?.checked;
    const amountLimits = Array.from(document.querySelectorAll('.amount-range')).map(input => input.value.trim());
    const serviceCharges = Array.from(document.querySelectorAll('.service-charge-item')).map(item => {
        return {
            condition: item.querySelector('.service-condition').value.trim(),
            charge: item.querySelector('.service-charge').value.trim()
        };
    });

    if (!name || !serviceType || amountLimits.length === 0) {
        alert('Please fill out all required fields.');
        return;
    }

    const supplierData = {
        name,
        isActive,
        services: [{
            serviceType,
            amountLimits: amountLimits.map(limit => ({ limit, rate: null })),
            serviceCharges
        }]
    };

    if (editingSupplierIndex === -1) {
        suppliers.push(supplierData);
        showNotification(`Supplier "${name}" added successfully!`, 'success');
    } else {
        suppliers[editingSupplierIndex] = supplierData;
        editingSupplierIndex = -1;
        this.textContent = 'Add Supplier';
        showNotification(`Supplier "${name}" updated successfully!`, 'success'); // Confirmation for editing
    }

    // Save to localStorage
    localStorage.setItem('suppliers', JSON.stringify(suppliers));

    // Update UI
    updateSupplierTables();
    updateDailyRateSection();
    clearSupplierForm();
});

// Remove Item (Amount Range or Service Charge)
function removeItem(button) {
    const item = button.parentNode;
    item.parentNode.removeChild(item);
}

// Clear Supplier Form
function clearSupplierForm() {
    document.getElementById('supplier-name').value = '';
    document.getElementById('service-type').value = '';
    document.getElementById('amount-limits-section').innerHTML = '';
    document.getElementById('service-charge-section').innerHTML = '';
    document.getElementById('additional-questions-container').innerHTML = '';
    document.getElementById('add-supplier-btn').textContent = 'Add Supplier';
    editingSupplierIndex = -1;
}

    function updateDailyRateSection() {
    const dailyRateSection = document.getElementById('daily-rate-section');
    if (!dailyRateSection) {
        console.error('Daily rate section element not found.');
        return;
    }

    // Clear the section before updating
    dailyRateSection.innerHTML = '';

    // Check if there are suppliers to display
    if (suppliers.length === 0) {
        const noSuppliersMessage = document.createElement('p');
        noSuppliersMessage.textContent = 'No suppliers available to display daily rates.';
        noSuppliersMessage.style.color = '#555';
        noSuppliersMessage.style.fontStyle = 'italic';
        dailyRateSection.appendChild(noSuppliersMessage);
        return;
    }

    // Iterate through suppliers and their services to populate daily rates
    suppliers.forEach(supplier => {
        const supplierHeader = document.createElement('h4');
        supplierHeader.textContent = `Supplier: ${supplier.name}`;
        dailyRateSection.appendChild(supplierHeader);

        supplier.services.forEach(service => {
            const serviceHeader = document.createElement('h5');
            serviceHeader.textContent = `Service: ${service.serviceType.replace(/-/g, ' ')}`;
            dailyRateSection.appendChild(serviceHeader);

            service.amountLimits.forEach(limit => {
                const rateRow = document.createElement('div');
                rateRow.classList.add('form-row');
                rateRow.innerHTML = `
                    <label>Amount Limit: ${limit.limit} - Rate:</label>
                    <input 
                        type="number" 
                        placeholder="Enter daily rate" 
                        value="${limit.rate || ''}" 
                        data-supplier="${supplier.name}" 
                        data-service="${service.serviceType}" 
                        data-limit="${limit.limit}"
                    >
                `;
                dailyRateSection.appendChild(rateRow);
            });
        });
    });
}

// Save Daily Rates
function saveDailyRates() {
    const rateInputs = document.querySelectorAll('#daily-rate-section input');
    if (rateInputs.length === 0) {
        console.warn('No daily rates to save.');
        return;
    }

    rateInputs.forEach(input => {
        const supplierName = input.getAttribute('data-supplier');
        const serviceType = input.getAttribute('data-service');
        const limit = input.getAttribute('data-limit');
        const rate = parseFloat(input.value);

        const supplier = suppliers.find(s => s.name === supplierName);
        if (supplier) {
            const service = supplier.services.find(s => s.serviceType === serviceType);
            if (service) {
                const amountLimit = service.amountLimits.find(a => a.limit === limit);
                if (amountLimit) {
                    amountLimit.rate = isNaN(rate) ? null : rate;
                }
            }
        }
    });

    // Save updated data to localStorage
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    console.log('Daily rates saved successfully.');
}

// Ensure daily rate section is updated on page load
document.addEventListener('DOMContentLoaded', function () {
    // Load suppliers from localStorage if available
    const storedSuppliers = localStorage.getItem('suppliers');
    if (storedSuppliers) {
        suppliers = JSON.parse(storedSuppliers);
    }

    // Update daily rate section on load
    updateDailyRateSection();

    // Add event listener to save rates when necessary
    document.getElementById('daily-rate-section')?.addEventListener('input', () => {
        saveDailyRates();
    });
});

// Add DOMContentLoaded Event Listener
document.addEventListener('DOMContentLoaded', function () {
    const addSupplierButton = document.getElementById('add-supplier-btn');
    const cancelEditButton = document.getElementById('cancel-edit-btn');
    const saveRatesButton = document.getElementById('save-rates-btn');
    const clearRatesButton = document.getElementById('clear-rates-btn');

    let editingSupplierIndex = -1;

    // Edit Supplier
    function editSupplier(index) {
        const supplier = suppliers[index];
        if (!supplier) {
            showNotification('Supplier not found.', 'warning');
            return;
        }

        document.getElementById('supplier-name').value = supplier.name;
        document.getElementById('service-type').value = supplier.services[0].serviceType;
        document.getElementById('supplier-status').checked = supplier.isActive;

        // Populate amount limits
        const amountLimitsSection = document.getElementById('amount-limits-section');
        amountLimitsSection.innerHTML = '';
        supplier.services[0].amountLimits.forEach(limit => {
            const div = document.createElement('div');
            div.classList.add('amount-range-item');
            div.innerHTML = `
                <input type="text" class="amount-range" value="${limit.limit}" />
                <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>`;
            amountLimitsSection.appendChild(div);
        });

        // Populate service charges
        const serviceChargeSection = document.getElementById('service-charge-section');
        serviceChargeSection.innerHTML = '';
        supplier.services[0].serviceCharges.forEach(charge => {
            const div = document.createElement('div');
            div.classList.add('service-charge-item');
            div.innerHTML = `
                <input type="text" class="service-condition" value="${charge.condition}" />
                <input type="text" class="service-charge" value="${charge.charge}" />
                <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>`;
            serviceChargeSection.appendChild(div);
        });

        editingSupplierIndex = index;
        toggleEditMode(true);
        showNotification('You have entered edit mode.', 'info');
    }

    // Cancel Edit
    cancelEditButton.addEventListener('click', function () {
        editingSupplierIndex = -1;
        clearSupplierForm();
        toggleEditMode(false);
        showNotification('Edit mode discharged.', 'warning');
    });

    // Save Edit or Add Supplier
    addSupplierButton.addEventListener('click', function () {
        const name = document.getElementById('supplier-name').value.trim();
        const serviceType = document.getElementById('service-type').value;
        const isActive = document.getElementById('supplier-status').checked;

        const amountLimits = Array.from(document.querySelectorAll('.amount-range'))
            .map(input => input.value.trim())
            .filter(limit => limit);

        const serviceCharges = Array.from(document.querySelectorAll('.service-charge-item')).map(item => {
            const condition = item.querySelector('.service-condition').value.trim();
            const charge = item.querySelector('.service-charge').value.trim();
            return { condition, charge };
        });

        if (!name || !serviceType || amountLimits.length === 0) {
            showNotification('Please fill out all required fields.', 'warning');
            return;
        }

        const supplierData = {
            name,
            isActive,
            services: [{
                serviceType,
                amountLimits: amountLimits.map(limit => ({ limit, rate: null })),
                serviceCharges
            }]
        };

        if (editingSupplierIndex === -1) {
            suppliers.push(supplierData);
            showNotification(`Supplier "${name}" added successfully!`, 'success');
        } else {
            suppliers[editingSupplierIndex] = supplierData;
            editingSupplierIndex = -1;
            showNotification(`Supplier "${name}" updated successfully!`, 'success');
        }

        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        updateSupplierTables();
        updateDailyRateSection();
        clearSupplierForm();
        toggleEditMode(false);
    });

    // Save Rates
    saveRatesButton.addEventListener('click', function () {
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            const supplierName = input.dataset.supplier;
            const serviceType = input.dataset.service;
            const limit = input.dataset.limit;
            const rate = parseFloat(input.value);

            const supplier = suppliers.find(s => s.name === supplierName);
            if (supplier) {
                const service = supplier.services.find(s => s.serviceType === serviceType);
                if (service) {
                    const amountLimit = service.amountLimits.find(a => a.limit === limit);
                    if (amountLimit) {
                        amountLimit.rate = isNaN(rate) ? null : rate;
                    }
                }
            }
        });

        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        showNotification('New rates saved successfully.', 'success');
        updateDailyRateSection();
    });

    // Clear Rates
    clearRatesButton.addEventListener('click', function () {
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            input.value = '';
        });

        // Save the cleared rates to suppliers
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            const supplierName = input.dataset.supplier;
            const serviceType = input.dataset.service;
            const limit = input.dataset.limit;

            const supplier = suppliers.find(s => s.name === supplierName);
            if (supplier) {
                const service = supplier.services.find(s => s.serviceType === serviceType);
                if (service) {
                    const amountLimit = service.amountLimits.find(a => a.limit === limit);
                    if (amountLimit) {
                        amountLimit.rate = null;
                    }
                }
            }
        });

        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        showNotification('Rates are now cleared.', 'warning');
        updateDailyRateSection();
    });

    // Toggle Edit Mode
    function toggleEditMode(isEditMode) {
        if (isEditMode) {
            addSupplierButton.textContent = 'Save Edit';
            cancelEditButton.style.display = 'inline-block';
        } else {
            addSupplierButton.textContent = 'Add Supplier';
            cancelEditButton.style.display = 'none';
        }
    }

    // Clear Supplier Form
    function clearSupplierForm() {
        document.getElementById('supplier-name').value = '';
        document.getElementById('service-type').value = '';
        document.getElementById('supplier-status').checked = false;
        document.getElementById('amount-limits-section').innerHTML = '';
        document.getElementById('service-charge-section').innerHTML = '';
        editingSupplierIndex = -1;
    }

    // Show Notification
    function showNotification(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.right = '20px';
        notification.style.backgroundColor = type === 'success' ? '#10b981' : (type === 'warning' ? '#f59e0b' : '#007BFF');
        notification.style.color = 'white';
        notification.style.padding = '15px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0px 4px 15px rgba(0, 0, 0, 0.2)';
        notification.style.fontSize = '16px';
        notification.style.zIndex = 1000;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, duration);
    }
});

    // Save Rates
    saveRatesButton.addEventListener('click', saveDailyRates);

    // Clear Rates
    clearRatesButton.addEventListener('click', function () {
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            input.value = '';
        });
        saveDailyRates();
    });

    // Edit Rates
    editRatesButton.addEventListener('click', function () {
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            input.disabled = false;
        });
    });

    // Function to Save Daily Rates
    function saveDailyRates() {
        document.querySelectorAll('#daily-rate-section input').forEach(input => {
            const supplierName = input.dataset.supplier;
            const serviceType = input.dataset.service;
            const limit = input.dataset.limit;
            const rate = parseFloat(input.value);

            const supplier = suppliers.find(s => s.name === supplierName);
            if (supplier) {
                const service = supplier.services.find(s => s.serviceType === serviceType);
                if (service) {
                    const amountLimit = service.amountLimits.find(a => a.limit === limit);
                    if (amountLimit) {
                        amountLimit.rate = isNaN(rate) ? null : rate;
                    }
                }
            }
        });

        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        showNotification('Daily rates saved successfully!', 'success');
        updateDailyRateSection();
    }

    // Clear Supplier Form
    function clearSupplierForm() {
        document.getElementById('supplier-name').value = '';
        document.getElementById('service-type').value = '';
        document.getElementById('supplier-status').checked = false;
        document.getElementById('amount-limits-section').innerHTML = '';
        document.getElementById('service-charge-section').innerHTML = '';
        editingSupplierIndex = -1;
    }

     // Add Order Functionality
    document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('createOrderBtn').addEventListener('click', function () {
        const serviceType = document.getElementById('serviceType')?.value;
        const orderAmount = parseFloat(document.getElementById('orderAmount')?.value);
        const orderTable = document.getElementById('orderTable')?.querySelector('tbody');

        // Validate inputs
        if (!serviceType || orderAmount <= 0.01) {
            alert('Please select a valid service type and enter a valid order amount.');
            return;
        }

        // Debugging: Log basic inputs
        console.log('Service Type:', serviceType);
        console.log('Order Amount:', orderAmount);

        // Collect additional info based on service type
        let additionalInfo = '';
        if (serviceType === 'bankTransferSaver' || serviceType === 'bankTransferExpress') {
            const englishAccount = document.getElementById('englishAccount')?.value;
            const gsyhAccount = document.getElementById('gsyhAccount')?.value;
            const nongyehAccount = document.getElementById('nongyehAccount')?.value;

            if (!englishAccount || !gsyhAccount || !nongyehAccount) {
                alert('Please complete all required additional fields.');
                return;
            }

            additionalInfo = `
                English Account: ${englishAccount},
                工商银行 Account: ${gsyhAccount},
                农业银行 Account: ${nongyehAccount}
            `;

            // Debugging: Log additional info for this service type
            console.log('Additional Info (Bank Transfer Saver/Express):', additionalInfo);
        } else if (serviceType === 'bankTransferUSD') {
            const accountType = document.getElementById('accountType')?.value;

            if (!accountType) {
                alert('Please select an Account Type.');
                return;
            }

            additionalInfo = `Account Type: ${accountType}`;

            // Debugging: Log additional info for USD transfers
            console.log('Additional Info (Bank Transfer USD):', additionalInfo);
        } else if (serviceType === 'alipay') {
            const englishAccount = document.getElementById('englishAccount')?.value;
            const chineseAccount = document.getElementById('chineseAccount')?.value;

            if (!englishAccount || !chineseAccount) {
                alert('Please complete all required additional fields.');
                return;
            }

            additionalInfo = `
                English Account: ${englishAccount},
                Chinese Account: ${chineseAccount}
            `;

            // Debugging: Log additional info for Alipay
            console.log('Additional Info (Alipay):', additionalInfo);
        } else {
            additionalInfo = 'N/A';
        }

        // Create and append the new row to the order table
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${serviceType.replace(/([A-Z])/g, ' $1').trim()}</td>
            <td>${orderAmount.toFixed(2)}</td>
            <td>${additionalInfo}</td>
            <td class="best-supplier">Calculating...</td>
        `;

        // Debugging: Log the created row for verification
        console.log('New Row:', newRow.innerHTML);

        orderTable.appendChild(newRow);

        // Confirmation
        alert('Order added successfully!');
    });
});

// Handle additional questions
document.addEventListener('DOMContentLoaded', function () {
    // Handle Additional Questions Based on Service Type
    function handleAdditionalQuestionsBasedOnService(serviceType) {
        const questionsContainer = document.getElementById('additionalQuestions');
        
        // Clear existing additional questions
        questionsContainer.innerHTML = '';

        // Define additional questions for each service type
        const additionalQuestionsMap = {
            'bankTransferSaver': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: '工商银行 Account', type: 'select', options: ['Yes', 'No'] },
                { label: '农业银行 Account', type: 'select', options: ['Yes', 'No'] }
            ],
            'bankTransferExpress': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: '工商银行 Account', type: 'select', options: ['Yes', 'No'] },
                { label: '农业银行 Account', type: 'select', options: ['Yes', 'No'] }
            ],
            'bankTransferUSD': [
                { label: 'Account Type', type: 'select', options: ['Personal', 'Company'] }
            ],
            'alipay': [
                { label: 'English Account', type: 'select', options: ['Yes', 'No'] },
                { label: 'Chinese Account', type: 'select', options: ['Yes', 'No'] }
            ]
        };

        // Match the selected service type to additional questions
        const questions = additionalQuestionsMap[serviceType];

        // Render the questions if they exist
        if (questions) {
            questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('form-group');
                questionDiv.innerHTML = `
                    <label>${question.label}</label>
                    ${
                        question.type === 'select'
                            ? `<select>${question.options.map(option => `<option value="${option.toLowerCase()}">${option}</option>`).join('')}</select>`
                            : `<input type="${question.type}" placeholder="${question.placeholder || ''}" />`
                    }
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }
    }

    // Add an event listener for service type selection
    const serviceTypeElement = document.getElementById('serviceType');
    if (serviceTypeElement) {
        serviceTypeElement.addEventListener('change', function() {
            const selectedServiceType = this.value;
            handleAdditionalQuestionsBasedOnService(selectedServiceType);
        });
    }
});

// Calculate Best Supplier
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('calculateBestSupplierBtn').addEventListener('click', function () {
        const rows = document.querySelectorAll('#orderTable tbody tr');

        // Debugging: Log the rows in the table
        console.log('Order Rows:', rows);

        if (rows.length === 0) {
            alert('No orders to process.');
            return;
        }

        rows.forEach(row => {
            console.log('Processing Row:', row);

            const serviceTypeCell = row.cells[0].textContent.trim().toLowerCase();
            const orderAmount = parseFloat(row.cells[1].textContent.trim());
            const additionalInfoCell = row.cells[2].textContent.trim();
            let bestSupplier = null;
            let lowestTotalCost = Infinity;

            // Debugging: Log order details
            console.log('Order Details:', { serviceTypeCell, orderAmount, additionalInfoCell });

            // Parse additional info into a key-value map
            const additionalInfo = {};
            additionalInfoCell.split(',').forEach(info => {
                const [key, value] = info.split(':').map(s => s.trim());
                additionalInfo[key.toLowerCase()] = value.toLowerCase();
            });

            // Consider only active suppliers
            suppliers.filter(supplier => supplier.isActive).forEach(supplier => {
                // Find the service that matches the current order's service type
                const service = supplier.services.find(s => s.serviceType.replace(/-/g, ' ').toLowerCase() === serviceTypeCell);
                if (!service) return;

                console.log(`Checking Supplier: ${supplier.name}, Service: ${service.serviceType}`);

                // Check if the order amount satisfies the supplier's amount limits
                const amountLimit = service.amountLimits.find(a => {
                    const [min, max] = a.limit.split('-').map(num => parseFloat(num.trim()));
                    return orderAmount >= min && orderAmount <= max;
                });

                // Validate the supplier's additional questions
                const matchesAdditionalQuestions = service.additionalQuestions.every(question => {
                    const questionKey = question.label.toLowerCase();
                    const expectedValue = question.value.toLowerCase();
                    return additionalInfo[questionKey] === expectedValue;
                });

                if (amountLimit && matchesAdditionalQuestions) {
                    // Fetch the supplier's daily rate for the service
                    const dailyRateInput = document.querySelector(
                        `input[data-supplier="${supplier.name}"][data-service="${service.serviceType}"]`
                    );
                    const dailyRate = dailyRateInput ? parseFloat(dailyRateInput.value) : null;

                    if (dailyRate && dailyRate > 0) {
                        // Calculate applicable service charges
                        const serviceCharge = calculateServiceCharge(orderAmount, service.serviceCharges);

                        // Calculate the effective total cost in RM
                        const totalCost = (orderAmount + serviceCharge) / dailyRate;

                        // Debugging: Log calculated costs
                        console.log(`Supplier: ${supplier.name}, Total Cost: ${totalCost}, Rate: ${dailyRate}, Service Charge: ${serviceCharge}`);

                        // Update the best supplier if this supplier offers a lower total cost
                        if (totalCost < lowestTotalCost) {
                            lowestTotalCost = totalCost;
                            bestSupplier = supplier.name;
                        }
                    } else {
                        console.error(`Invalid daily rate for supplier: ${supplier.name}`);
                    }
                }
            });

            // Update the best supplier cell in the table row
            const bestSupplierCell = row.querySelector('.best-supplier');
            if (bestSupplierCell) {
                bestSupplierCell.textContent = bestSupplier ? bestSupplier : 'No suitable supplier found';
            } else {
                console.error('Best Supplier Cell not found for row:', row);
            }
        });

        alert('Best supplier calculation completed.');
    });

    // Calculate service charges during order processing
    function calculateServiceCharge(orderAmount, serviceCharges) {
        let totalServiceCharge = 0;

        serviceCharges.forEach(charge => {
            const condition = charge.condition;
            const chargeAmount = parseFloat(charge.charge.replace(/[^0-9.]/g, '')); // Extract numeric value of charge
            if (evaluateCondition(condition, orderAmount)) {
                totalServiceCharge += chargeAmount;
            }
        });

        return totalServiceCharge;
    }

    // Utility function to evaluate conditions (>, <, range) for service charges
    function evaluateCondition(condition, amount) {
        try {
            if (!condition) return false;
            condition = condition.toLowerCase();

            if (condition.includes('>')) {
                const value = parseFloat(condition.split('>')[1]);
                return amount > value;
            } else if (condition.includes('<')) {
                const value = parseFloat(condition.split('<')[1]);
                return amount < value;
            } else if (condition.includes('-')) {
                const [min, max] = condition.split('-').map(parseFloat);
                return amount >= min && amount <= max;
            }

            return false;
        } catch (error) {
            console.error(`Error evaluating condition: ${condition}`, error);
            return false;
        }
    }
});

    // Sync Suppliers to Google Sheet
    const googleSheetApiUrl = ""; // Add your Google Sheet API URL here

    document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('sync-suppliers-btn').addEventListener('click', async function () {
        try {
            const suppliersData = localStorage.getItem('suppliers');
            if (!suppliersData) {
                alert('No suppliers to sync.');
                return;
            }

            const suppliers = JSON.parse(suppliersData);

            const formattedData = suppliers.map(supplier => ({
                name: supplier.name,
                isActive: supplier.isActive ? 'Active' : 'Inactive',
                services: supplier.services.map(service => ({
                    serviceType: service.serviceType,
                    amountLimits: service.amountLimits.map(a => a.limit).join(', '),
                    serviceCharges: service.serviceCharges.map(c => `${c.condition}: ${c.charge}`).join(', '),
                    additionalQuestions: service.additionalQuestions.map(q => `${q.label}: ${q.value}`).join(', ')
                }))
            }));

            const response = await fetch(googleSheetApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ suppliers: formattedData })
            });

            if (response.ok) {
                alert('Suppliers successfully synced to Google Sheet!');
            } else {
                alert('Failed to sync suppliers. Check your Google Sheet API setup.');
            }
        } catch (error) {
            console.error('Error syncing suppliers:', error);
            alert('An error occurred while syncing suppliers.');
        }
    });
  });

    async function fetchSuppliersFromGoogleSheet() {
    try {
        const googleSheetApiUrl = ""; // Replace with your Google Sheets API URL
        const response = await fetch(googleSheetApiUrl);

        if (!response.ok) {
            throw new Error('Failed to fetch data from Google Sheets.');
        }

        const data = await response.json();

        if (data.status === "success") {
            const suppliersFromSheet = data.data;

            // Transform data into the format your system uses
            const transformedSuppliers = suppliersFromSheet.map(sheetSupplier => ({
                name: sheetSupplier["Name"], // Replace with the actual column names
                isActive: sheetSupplier["Status"] === "Active",
                services: JSON.parse(sheetSupplier["Services"]), // Assumes JSON strings for services
            }));

            // Save to localStorage
            localStorage.setItem('suppliers', JSON.stringify(transformedSuppliers));
            suppliers = transformedSuppliers;
            updateSupplierTables();
            updateDailyRateSection();

            alert('Suppliers successfully fetched and loaded from Google Sheets!');
        } else {
            throw new Error(data.message || 'Unknown error occurred.');
        }
    } catch (error) {
        console.error('Error fetching suppliers:', error);
        alert('An error occurred while fetching suppliers from Google Sheets.');
    }
}

// Button to trigger fetch
document.addEventListener('DOMContentLoaded', function () {
document.getElementById('fetch-suppliers-btn').addEventListener('click', fetchSuppliersFromGoogleSheet);
});

</script>
</body>
</html>
