<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Determination and Management System</title>
<style>
    /* General Styling */
body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    margin: 0;
    padding: 20px;
    color: #333;
}

.container, .calculator-container {
    max-width: 1200px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    padding: 25px;
}

.form-group, .form-row {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
}

input, select {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #f9f9fb;
    transition: border-color 0.3s;
}

input:focus, select:focus {
    border-color: #007BFF;
    outline: none;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    background-color: #007BFF;
    color: #ffffff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
}

.btn:hover {
    background-color: #0056b3;
}

.order-table, table {
    width: 100%;
    margin-top: 25px;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 10px;
    overflow: hidden;
}

.order-table th, .order-table td, th, td {
    border-bottom: 1px solid #e0e0e0;
    padding: 12px 15px;
    text-align: center;
    color: #333;
}

.order-table th {
    background-color: #f1f5f9;
    font-weight: 600;
    color: #444;
}

.toggle-btn {
    display: block;
    margin: 15px auto;
    background-color: #10b981;
    padding: 10px 24px;
    font-weight: 600;
}

.toggle-btn:hover {
    background-color: #059669;
}

.hidden {
    display: none;
}

.tab {
    display: inline-block;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    font-weight: 500;
    color: #555;
    transition: color 0.3s, border-color 0.3s;
}

.tab.active {
    border-bottom: 2px solid #007BFF;
    color: #007BFF;
}

.tab-content {
    display: none;
    margin-top: 20px;
}

.tab-content.active {
    display: block;
}
</style>
</head>
<body>

<div class="calculator-container">
    <h2>Supplier Determination Calculator</h2>
    <div class="form-group">
        <label for="serviceType">Select Service Type:</label>
        <select id="serviceType">
            <option value="">Select a service</option>
            <option value="bankTransferSaver">Bank Transfer (Saver)</option>
            <option value="bankTransferExpress">Bank Transfer (Express)</option>
            <option value="bankTransferUSD">Bank Transfer (USD)</option>
            <option value="enterpriseToEnterprise">Enterprise to Enterprise</option>
            <option value="alipay">Alipay</option>
        </select>
    </div>
    <div class="form-group">
        <label for="orderAmount">Enter Order Amount (must be > 0.01):</label>
        <input type="number" id="orderAmount" min="0.01" step="0.01" placeholder="Enter amount">
    </div>
    <div id="additionalQuestions"></div>
    <button class="btn" id="createOrderBtn">Create Order</button>
    <button class="btn" id="calculateBestSupplierBtn">Calculate the Best Supplier</button>

    <table class="order-table" id="orderTable">
        <thead>
            <tr>
                <th>Service Type</th>
                <th>Order Amount</th>
                <th>Additional Info</th>
                <th>Best Supplier</th>
            </tr>
        </thead>
        <tbody>
            <!-- Orders will be populated here -->
        </tbody>
    </table>
</div>

<button class="btn toggle-btn" id="toggleManagementBtn">Show Supplier Management</button>

<div class="container hidden" id="supplierManagementSection">
    <h2>Supplier Management</h2>

    <h3>Daily Rate</h3>
    <div id="daily-rate-section"></div>

    <h3>Add/Edit Supplier</h3>
    <div class="form-row">
        <label for="supplier-name">Supplier Name</label>
        <input type="text" id="supplier-name" placeholder="Enter supplier name">
    </div>
    <div class="form-row">
        <label for="service-type">Service Type</label>
        <select id="service-type">
            <option value="bank-express">Bank Transfer (Express)</option>
            <option value="bank-saver">Bank Transfer (Saver)</option>
            <option value="enterprise">Enterprise to Enterprise</option>
            <option value="usd-transfer">Bank Transfer (USD)</option>
            <option value="alipay">Alipay Transfer</option>
        </select>
    </div>
    <div class="form-row">
        <label>Amount Limits</label>
        <div id="amount-limits-section"></div>
    </div>
    <button class="btn" id="add-amount-range-btn">Add Amount Range</button>

    <div class="form-row">
        <label>Service Charges</label>
        <div id="service-charge-section"></div>
    </div>
    <button class="btn" id="add-service-charge-btn">Add Service Charge</button>

    <h3>Additional Questions</h3>
    <div id="additional-questions-container"></div>

    <button class="btn" id="add-supplier-btn">Add Supplier</button>

    <h3>Supplier Information</h3>
    <button id="sync-data-btn">Sync Data</button>
    <div class="tabs" id="service-tabs">
        <div class="tab" data-service="bank-express">Bank Transfer (Express)</div>
        <div class="tab" data-service="bank-saver">Bank Transfer (Saver)</div>
        <div class="tab" data-service="enterprise">Enterprise to Enterprise</div>
        <div class="tab" data-service="usd-transfer">Bank Transfer (USD)</div>
        <div class="tab" data-service="alipay">Alipay Transfer</div>
    </div>

    <div id="tab-content-container">
        <div class="tab-content" id="bank-express-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bank-express-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="bank-saver-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bank-saver-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="enterprise-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="enterprise-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="usd-transfer-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usd-transfer-table-body"></tbody>
            </table>
        </div>
        <div class="tab-content" id="alipay-tab">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Amount Limits</th>
                        <th>Service Charges</th>
                        <th>Additional Questions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alipay-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function syncData() {
    try {
        const response = await fetch(https://script.google.com/macros/s/AKfycbwEc-L0uHGAp5WtstUnG-QFI48GITiZdx85nQ4qngSl2nUc7U9ljCCBg5MFsXS0k4g/exec);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (!Array.isArray(data)) {
            throw new Error('Expected an array of suppliers from API.');
        }
        suppliers = data;
        updateSupplierTables();
        updateDailyRateSection();
        alert("Data synced successfully.");
    } catch (error) {
        console.error('Failed to sync data:', error);
        alert("Error syncing data: " + error.message);
    }
}

document.getElementById('add-supplier-btn').addEventListener('click', () => {
    const nameInput = document.getElementById('supplier-name');
    const serviceTypeInput = document.getElementById('service-type');

    // Validate form fields
    if (!nameInput || !serviceTypeInput) {
        alert("Required form fields are missing.");
        return;
    }

    const name = nameInput.value.trim();
    const serviceType = serviceTypeInput.value.trim();

    const amountLimits = Array.from(document.querySelectorAll('.amount-range'))
        .map(input => input.value.trim())
        .filter(Boolean); // Removes empty values

    const serviceCharges = Array.from(document.querySelectorAll('.service-charge-item')).map(item => {
        const conditionInput = item.querySelector('.service-condition');
        const chargeInput = item.querySelector('.service-charge');
        return conditionInput && chargeInput ? {
            condition: conditionInput.value.trim(),
            charge: chargeInput.value.trim()
        } : null;
    }).filter(Boolean);

    const additionalQuestions = Array.from(document.querySelectorAll('#additional-questions-container .form-row')).map(row => {
        const label = row.querySelector('label');
        const select = row.querySelector('select');
        return label && select ? {
            label: label.textContent.trim(),
            value: select.value.trim()
        } : null;
    }).filter(Boolean);

    if (!name || !serviceType || amountLimits.length === 0) {
        alert("Please fill in all required fields.");
        return;
    }

    const supplierData = {
        name,
        services: [{
            serviceType,
            amountLimits: amountLimits.map(limit => ({ limit, rate: null })), // Keep 'rate: null'
            serviceCharges,
            additionalQuestions
        }]
    };

    if (editingSupplierIndex > -1) {
        // Editing an existing supplier
        suppliers[editingSupplierIndex] = supplierData;
        editingSupplierIndex = -1; // Reset editing index
        alert("Supplier updated locally. Click 'Sync Data' to save to the database.");
        document.getElementById('add-supplier-btn').textContent = 'Add Supplier';
    } else {
        // Adding a new supplier
        suppliers.push(supplierData);
        alert("Supplier added locally. Click 'Sync Data' to save to the database.");
    }

    updateSupplierTables();
    updateDailyRateSection();
    clearSupplierForm();
});

// Function to update the Daily Rate section dynamically
function updateDailyRateSection() {
    const dailyRateSection = document.getElementById('daily-rate-section');
    if (!dailyRateSection) {
        console.warn("Daily rate section not found in DOM.");
        return;
    }

    dailyRateSection.innerHTML = ''; // Clear previous content

    suppliers.forEach(supplier => {
        supplier.services.forEach(service => {
            service.amountLimits.forEach(limit => {
                const rateInput = document.createElement('div');
                rateInput.innerHTML = `
                    <label>${supplier.name} - ${service.serviceType} (${limit.limit}):</label>
                    <input type="number" 
                           data-supplier="${supplier.name}" 
                           data-service="${service.serviceType}" 
                           data-limit="${limit.limit}" 
                           value="${limit.rate || ''}" />
                `;
                dailyRateSection.appendChild(rateInput);
            });
        });
    });

    // Attach change listeners to all rate inputs
    document.querySelectorAll('#daily-rate-section input[type="number"]').forEach(input => {
        input.addEventListener('change', (e) => {
            const { supplier, service, limit } = e.target.dataset;
            const rate = parseFloat(e.target.value);

            if (isNaN(rate) || rate < 0) {
                alert("Please enter a valid positive number for the rate.");
                e.target.value = ''; // Reset invalid value
                return;
            }

            // Update the corresponding limit in the suppliers array
            const supplierData = suppliers.find(s => s.name === supplier);
            if (supplierData) {
                const serviceData = supplierData.services.find(s => s.serviceType === service);
                if (serviceData) {
                    const limitData = serviceData.amountLimits.find(l => l.limit === limit);
                    if (limitData) {
                        limitData.rate = rate; // Update the rate
                    }
                }
            }
        });
    });
}

// Function to fill the form with supplier data for editing
function editSupplier(index) {
    const supplier = suppliers[index];
    if (!supplier) {
        console.warn(`Supplier at index ${index} not found.`);
        return;
    }

    document.getElementById('supplier-name').value = supplier.name;

    // Handle multiple services (currently picking the first service as a default)
    if (supplier.services.length > 0) {
        const service = supplier.services[0]; // Default to the first service
        document.getElementById('service-type').value = service.serviceType;

        // Populate amount limits
        const amountLimitsSection = document.getElementById('amount-limits-section');
        amountLimitsSection.innerHTML = ''; // Clear previous content
        service.amountLimits.forEach(range => {
            const amountRangeItem = document.createElement('div');
            amountRangeItem.classList.add('amount-range-item');
            amountRangeItem.innerHTML = `
                <input type="text" class="amount-range" value="${range.limit}" />
                <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
            `;
            amountLimitsSection.appendChild(amountRangeItem);
        });

        // Populate service charges
        const serviceChargeSection = document.getElementById('service-charge-section');
        serviceChargeSection.innerHTML = ''; // Clear previous content
        service.serviceCharges.forEach(charge => {
            const serviceChargeItem = document.createElement('div');
            serviceChargeItem.classList.add('service-charge-item');
            serviceChargeItem.innerHTML = `
                <div>
                    <label>Condition</label>
                    <input type="text" class="service-condition" value="${charge.condition}" />
                </div>
                <div>
                    <label>Charge</label>
                    <input type="text" class="service-charge" value="${charge.charge}" />
                </div>
                <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
            `;
            serviceChargeSection.appendChild(serviceChargeItem);
        });

        // Populate additional questions
        const additionalQuestionsContainer = document.getElementById('additional-questions-container');
        additionalQuestionsContainer.innerHTML = ''; // Clear previous content
        service.additionalQuestions.forEach(question => {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('form-row');
            questionDiv.innerHTML = `
                <label>${question.label}</label>
                <select>
                    <option value="yes" ${question.value === 'yes' ? 'selected' : ''}>Yes</option>
                    <option value="no" ${question.value === 'no' ? 'selected' : ''}>No</option>
                </select>
            `;
            additionalQuestionsContainer.appendChild(questionDiv);
        });
    }

    editingSupplierIndex = index; // Set editing index
    document.getElementById('add-supplier-btn').textContent = 'Update Supplier';
}

// Function to sync suppliers to the backend (Google Sheets)
async function syncSuppliersToDatabase() {
    const syncButton = document.getElementById('sync-data-btn');
    if (syncButton) syncButton.disabled = true;

    try {
        const response = await fetch(apiURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'syncSuppliers', suppliers })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        if (result.status === "success") {
            alert("Suppliers synced to database successfully.");
        } else {
            throw new Error('Failed to sync suppliers to the database');
        }
    } catch (error) {
        console.error('Failed to sync suppliers to database:', error);
        alert("Error syncing suppliers: " + error.message);
    } finally {
        if (syncButton) syncButton.disabled = false;
    }
}

// Function to delete a supplier from the local array and the backend
async function deleteSupplier(index) {
    const supplierToDelete = suppliers[index]?.name;
    if (!supplierToDelete) {
        console.warn(`Supplier at index ${index} not found.`);
        return;
    }

    try {
        const response = await fetch(apiURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'deleteSupplier', supplierName: supplierToDelete })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        if (result.status === "success") {
            suppliers.splice(index, 1); // Remove from local array
            updateSupplierTables(); // Refresh UI
            alert('Supplier deleted successfully.');
        } else {
            throw new Error('Failed to delete supplier');
        }
    } catch (error) {
        console.error('Error deleting supplier:', error);
        alert("Error deleting supplier: " + error.message);
    }
}

// Function to save daily rates and update Google Sheets
function saveDailyRates() {
    const updatedRates = [];

    document.querySelectorAll('#daily-rate-section input').forEach(input => {
        const supplierName = input.getAttribute('data-supplier');
        const serviceType = input.getAttribute('data-service');
        const limit = input.getAttribute('data-limit');
        const rate = parseFloat(input.value);

        if (!isNaN(rate)) {
            updatedRates.push({ supplierName, serviceType, limit, rate });
        } else {
            console.warn(`Invalid rate for supplier: ${supplierName}, service: ${serviceType}, limit: ${limit}`);
        }
    });

    if (updatedRates.length === 0) {
        alert("No valid rates to save. Please fill in the rates before saving.");
        return;
    }

    fetch(apiURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'updateRates', rates: updatedRates })
    })
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                alert("Daily rates updated successfully.");
                updateSupplierTables();
            } else {
                throw new Error('Failed to update rates');
            }
        })
        .catch(error => console.error('Error updating rates:', error));
}

// Add event listener to save rates button if not added already
const saveRatesButton = document.getElementById('save-daily-rates-btn');
if (saveRatesButton) {
    saveRatesButton.addEventListener('click', saveDailyRates);
} else {
    console.warn("Save Daily Rates button not found in the DOM.");
}

// Function to edit a supplier's information in the form
function editSupplier(index) {
    const supplier = suppliers[index];
    if (!supplier) {
        console.warn(`Supplier at index ${index} not found.`);
        return;
    }

    document.getElementById('supplier-name').value = supplier.name;

    if (!supplier.services || supplier.services.length === 0) {
        alert("This supplier has no services to edit.");
        return;
    }

    const service = supplier.services[0]; // Default to the first service
    document.getElementById('service-type').value = service.serviceType;

    // Populate amount limits
    const amountLimitsSection = document.getElementById('amount-limits-section');
    amountLimitsSection.innerHTML = '';
    service.amountLimits.forEach(range => {
        const amountRangeItem = document.createElement('div');
        amountRangeItem.classList.add('amount-range-item');
        amountRangeItem.innerHTML = `
            <input type="text" class="amount-range" value="${range.limit}" />
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        `;
        amountLimitsSection.appendChild(amountRangeItem);
    });

    // Populate service charges
    const serviceChargeSection = document.getElementById('service-charge-section');
    serviceChargeSection.innerHTML = '';
    service.serviceCharges.forEach(charge => {
        const serviceChargeItem = document.createElement('div');
        serviceChargeItem.classList.add('service-charge-item');
        serviceChargeItem.innerHTML = `
            <div>
                <label>Condition</label>
                <input type="text" class="service-condition" value="${charge.condition}" />
            </div>
            <div>
                <label>Charge</label>
                <input type="text" class="service-charge" value="${charge.charge}" />
            </div>
            <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        `;
        serviceChargeSection.appendChild(serviceChargeItem);
    });

    // Populate additional questions
    const additionalQuestionsContainer = document.getElementById('additional-questions-container');
    additionalQuestionsContainer.innerHTML = '';
    service.additionalQuestions.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('form-row');
        questionDiv.innerHTML = `
            <label>${question.label}</label>
            <select>
                <option value="yes" ${question.value === 'yes' ? 'selected' : ''}>Yes</option>
                <option value="no" ${question.value === 'no' ? 'selected' : ''}>No</option>
            </select>
        `;
        additionalQuestionsContainer.appendChild(questionDiv);
    });

    editingSupplierIndex = index;
    document.getElementById('add-supplier-btn').textContent = 'Update Supplier';
}

// Function to dynamically manage the calculator for determining the best supplier
document.getElementById('createOrderBtn').addEventListener('click', function () {
    const serviceType = document.getElementById('serviceType').value;
    const orderAmount = parseFloat(document.getElementById('orderAmount').value);
    const orderTable = document.getElementById('orderTable').querySelector('tbody');

    if (!serviceType || isNaN(orderAmount) || orderAmount <= 0.01) {
        alert('Please select a valid service type and enter a valid order amount.');
        return;
    }

    let additionalInfo = '';
    if (serviceType === 'bankTransferSaver' || serviceType === 'bankTransferExpress') {
        additionalInfo = `
            English Account: ${document.getElementById('englishAccount').value},
            工商银行 Account: ${document.getElementById('gsyhAccount').value},
            农业银行 Account: ${document.getElementById('nongyehAccount').value}
        `;
    } else if (serviceType === 'bankTransferUSD') {
        additionalInfo = `Account Type: ${document.getElementById('accountType').value}`;
    } else if (serviceType === 'alipay') {
        additionalInfo = `
            English Account: ${document.getElementById('englishAccount').value},
            Chinese Account: ${document.getElementById('chineseAccount').value}
        `;
    } else {
        additionalInfo = 'N/A';
    }

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>${serviceType.replace(/([A-Z])/g, ' $1').trim()}</td>
        <td>${orderAmount}</td>
        <td>${additionalInfo}</td>
        <td class="best-supplier">Calculating...</td>
    `;
    orderTable.appendChild(newRow);
});

document.getElementById('calculateBestSupplierBtn').addEventListener('click', function () {
    const rows = document.querySelectorAll('#orderTable tbody tr');

    if (rows.length === 0) {
        alert('No orders to process.');
        return;
    }

    rows.forEach(row => {
        const serviceTypeCell = row.cells[0].textContent.trim().toLowerCase();
        const orderAmount = parseFloat(row.cells[1].textContent.trim());
        const additionalInfoCell = row.cells[2].textContent.trim();
        let bestSupplier = null;
        let lowestTotalCost = Infinity;

        const additionalInfo = {};
        additionalInfoCell.split(',').forEach(info => {
            const [key, value] = info.split(':').map(s => s.trim());
            if (key && value) {
                additionalInfo[key.toLowerCase()] = value.toLowerCase();
            }
        });

        suppliers.forEach(supplier => {
            const service = supplier.services.find(s => s.serviceType.replace(/-/g, ' ').toLowerCase() === serviceTypeCell);
            if (service) {
                const amountLimit = service.amountLimits.find(a => {
                    const [min, max] = a.limit.split('-').map(num => parseFloat(num.trim()));
                    return orderAmount >= min && orderAmount <= max;
                });

                if (amountLimit && amountLimit.rate) {
                    let convertedOrderAmount = serviceTypeCell === 'usd transfer'
                        ? orderAmount * amountLimit.rate
                        : orderAmount / amountLimit.rate;

                    let totalCost = convertedOrderAmount;

                    service.serviceCharges.forEach(charge => {
                        if (evaluateCondition(charge.condition, orderAmount)) {
                            const chargeAmount = parseFloat(charge.charge.replace(/[^0-9.]/g, ''));
                            totalCost += chargeAmount;
                        }
                    });

                    if (totalCost < lowestTotalCost) {
                        lowestTotalCost = totalCost;
                        bestSupplier = supplier.name;
                    }
                }
            }
        });

        const bestSupplierCell = row.querySelector('.best-supplier');
        bestSupplierCell.textContent = bestSupplier ? bestSupplier : 'No suitable supplier found';
    });

    alert('Best supplier calculation completed.');
});

// Function to evaluate conditions for supplier charges
function evaluateCondition(condition, amount) {
    try {
        if (!condition) return false;
        condition = condition.toLowerCase();

        if (condition.includes('>')) {
            const value = parseFloat(condition.split('>')[1]);
            return amount > value;
        } else if (condition.includes('<')) {
            const value = parseFloat(condition.split('<')[1]);
            return amount < value;
        } else if (condition.includes('-')) {
            const [min, max] = condition.split('-').map(parseFloat);
            return !isNaN(min) && !isNaN(max) && amount >= min && amount <= max;
        }

        return false;
    } catch (e) {
        console.error(`Error evaluating condition: ${condition}`, e);
        return false;
    }
}

// Function to dynamically add or edit supplier fields
function removeItem(button) {
    if (button && button.parentNode && button.parentNode.parentNode) {
        button.parentNode.parentNode.removeChild(button.parentNode);
    } else {
        console.warn("Failed to remove item. Invalid button or parent node.");
    }
}

// Function to dynamically handle additional questions based on the selected service type
function generateAdditionalQuestions(serviceType, containerId) {
    const additionalQuestionsContainer = document.getElementById(containerId);
    if (!additionalQuestionsContainer) {
        console.warn(`Container with ID ${containerId} not found in DOM.`);
        return;
    }

    additionalQuestionsContainer.innerHTML = ''; // Clear previous questions

    if (serviceType === 'bankTransferSaver' || serviceType === 'bankTransferExpress') {
        additionalQuestionsContainer.innerHTML = `
            <div class="form-group">
                <label for="englishAccount">English Account:</label>
                <select id="englishAccount">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gsyhAccount">工商银行 Account:</label>
                <select id="gsyhAccount">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nongyehAccount">农业银行 Account:</label>
                <select id="nongyehAccount">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
        `;
    } else if (serviceType === 'bankTransferUSD') {
        additionalQuestionsContainer.innerHTML = `
            <div class="form-group">
                <label for="accountType">Account Type:</label>
                <select id="accountType">
                    <option value="personal">Personal</option>
                    <option value="company">Company</option>
                </select>
            </div>
        `;
    } else if (serviceType === 'alipay') {
        additionalQuestionsContainer.innerHTML = `
            <div class="form-group">
                <label for="englishAccount">English Account:</label>
                <select id="englishAccount">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="chineseAccount">Chinese Account:</label>
                <select id="chineseAccount">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
        `;
    } else {
        // No additional questions for other service types
        additionalQuestionsContainer.innerHTML = '';
    }
}

// Event listener for changes in the service type selection
document.getElementById('service-type').addEventListener('change', function () {
    const selectedService = this.value;
    generateAdditionalQuestions(selectedService, 'additional-questions-container');
});

// Initialize additional questions on page load if a type is already selected
window.addEventListener('load', () => {
    const initialServiceType = document.getElementById('service-type')?.value || '';
    generateAdditionalQuestions(initialServiceType, 'additional-questions-container');
});

// Toggle visibility of the supplier management section
document.getElementById('toggleManagementBtn').addEventListener('click', function () {
    const section = document.getElementById('supplierManagementSection');
    if (!section) {
        console.warn("Supplier management section not found in the DOM.");
        return;
    }

    section.classList.toggle('hidden');
    this.textContent = section.classList.contains('hidden')
        ? 'Show Supplier Management'
        : 'Hide Supplier Management';
});

// Functionality to add amount range input in Supplier Management
document.getElementById('add-amount-range-btn').addEventListener('click', () => {
    const amountRangeItem = document.createElement('div');
    amountRangeItem.classList.add('amount-range-item');
    amountRangeItem.innerHTML = `
        <input type="text" class="amount-range" placeholder="e.g. '> 0.01' or '10000 - 20000'" />
        <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
    `;
    document.getElementById('amount-limits-section').appendChild(amountRangeItem);
});

// Functionality to add service charge input in Supplier Management
document.getElementById('add-service-charge-btn').addEventListener('click', () => {
    const serviceChargeItem = document.createElement('div');
    serviceChargeItem.classList.add('service-charge-item');
    serviceChargeItem.innerHTML = `
        <div>
            <label>Condition</label>
            <input type="text" class="service-condition" placeholder="e.g. 'Company Account > 2000 USD'" />
        </div>
        <div>
            <label>Charge</label>
            <input type="text" class="service-charge" placeholder="e.g. 'CNY 50'" />
        </div>
        <button class="remove-item-btn" onclick="removeItem(this)">Remove</button>
    `;
    document.getElementById('service-charge-section').appendChild(serviceChargeItem);
});

// Helper function to remove an item dynamically
function removeItem(button) {
    if (button && button.parentNode && button.parentNode.parentNode) {
        button.parentNode.parentNode.removeChild(button.parentNode);
    } else {
        console.warn("Failed to remove item. Invalid button or parent node.");
    }
}

// Function to clear the supplier form after adding or updating a supplier
function clearSupplierForm() {
    document.getElementById('supplier-name').value = '';
    document.getElementById('service-type').value = '';
    document.getElementById('amount-limits-section').innerHTML = '';
    document.getElementById('service-charge-section').innerHTML = '';
    document.getElementById('additional-questions-container').innerHTML = '';
    document.getElementById('add-supplier-btn').textContent = 'Add Supplier';
    editingSupplierIndex = -1;
}

// Function to handle tab switching for supplier information
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function () {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

        this.classList.add('active');
        const targetContent = document.getElementById(`${this.dataset.service}-tab`);
        if (targetContent) {
            targetContent.classList.add('active');
        } else {
            console.warn(`Tab content for ${this.dataset.service} not found.`);
        }
    });
});

// Initialize tabs to show the first tab content on load
const firstTab = document.querySelector('.tab');
if (firstTab) firstTab.click();


</script>
    
</body>
</html>
